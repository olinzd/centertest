<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –≥—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .user-info {
            font-size: 16px;
            color: #666;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        .month-selector {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .calendar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5px;
            border: 1px solid #eee;
            font-size: 14px;
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
        }

        .calendar-day.has-shift {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .calendar-day.long-shift {
            background: #bbdefb;
            border-color: #1976d2;
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .shift-hours {
            font-size: 12px;
            color: #666;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="main-section">
            <div class="header">
                <h1>–ú–æ–π –≥—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω</h1>
                <div class="user-info">
                    –ü—Ä–∏–≤–µ—Ç, <span id="user-name"></span>!
                </div>
            </div>

            <div class="controls">
                <select id="month-selector" class="month-selector">
                    <option value="2025-09">–°–µ–Ω—Ç—è–±—Ä—å 2025</option>
                    <option value="2025-10">–û–∫—Ç—è–±—Ä—å 2025</option>
                    <option value="2025-11">–ù–æ—è–±—Ä—å 2025</option>
                    <option value="2025-12">–î–µ–∫–∞–±—Ä—å 2025</option>
                </select>
                <button id="refresh-btn" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <div id="calendar" class="calendar">
                <div class="calendar-header">
                    <div>–ü–Ω</div>
                    <div>–í—Ç</div>
                    <div>–°—Ä</div>
                    <div>–ß—Ç</div>
                    <div>–ü—Ç</div>
                    <div>–°–±</div>
                    <div>–í—Å</div>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKzFCRlqDU_zHfk_wG0P_QIzb0IE6z5riEBrzbHjm82XGGF-h2FyoiVRDkMKXqGemIcA/exec';

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const userName = document.getElementById('user-name');
        const monthSelector = document.getElementById('month-selector');
        const refreshBtn = document.getElementById('refresh-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const loading = document.getElementById('loading');

        let currentUser = null;
        let shiftsData = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            if (tg) {
                tg.expand();
                tg.ready();
            }
            initApp();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                currentUser = tg.initDataUnsafe.user;
                localStorage.setItem('tg_user_data', JSON.stringify(currentUser));
            } else {
                // Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º localStorage
                const savedUser = localStorage.getItem('tg_user_data');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    document.body.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <h2>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram</h2>
                            <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram</p>
                        </div>
                    `;
                    return;
                }
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            userName.textContent = `${currentUser.first_name}${currentUser.last_name ? ' ' + currentUser.last_name : ''}`;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            refreshBtn.addEventListener('click', loadShifts);
            monthSelector.addEventListener('change', renderCalendar);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadShifts();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–º–µ–Ω
        async function loadShifts() {
            showLoading(true);
            
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ Telegram ID
                const idsResponse = await fetch(`${APP_SCRIPT_URL}?function=getEmployeeIds&telegramId=${currentUser.id}`);
                
                if (!idsResponse.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${idsResponse.status}`);
                }
                
                const employeeIds = await idsResponse.json();
                console.log('–ù–∞–π–¥–µ–Ω—ã ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', employeeIds);
                
                if (employeeIds.length === 0) {
                    alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
                    showLoading(false);
                    return;
                }
                
                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–º–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö ID
                const allShifts = [];
                for (const id of employeeIds) {
                    const shiftsResponse = await fetch(`${APP_SCRIPT_URL}?function=getShiftsByEmployeeId&employeeId=${id}`);
                    
                    if (!shiftsResponse.ok) {
                        console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–º–µ–Ω –¥–ª—è ID ${id}`);
                        continue;
                    }
                    
                    const shifts = await shiftsResponse.json();
                    console.log(`–°–º–µ–Ω—ã –¥–ª—è ID ${id}:`, shifts);
                    allShifts.push(...shifts);
                }
                
                shiftsData = allShifts;
                console.log('–í—Å–µ —Å–º–µ–Ω—ã:', shiftsData);
                renderCalendar();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function renderCalendar() {
            const selectedMonth = monthSelector.value;
            const [year, month] = selectedMonth.split('-').map(Number);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–º–µ–Ω—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Å—è—Ü—É
            const monthShifts = shiftsData.filter(shift => {
                const shiftDate = new Date(shift.date);
                return shiftDate.getFullYear() === year && shiftDate.getMonth() + 1 === month;
            });
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            calendarGrid.innerHTML = '';
            
            // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            const firstDay = new Date(year, month - 1, 1);
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            
            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –¥–Ω–µ–º
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }
            
            // –î–Ω–∏ –º–µ—Å—è—Ü–∞
            const daysInMonth = new Date(year, month, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const shift = monthShifts.find(s => s.date === dateStr);
                
                dayElement.className = 'calendar-day';
                if (shift) {
                    dayElement.classList.add(shift.hours === 12 ? 'long-shift' : 'has-shift');
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${shift ? `<div class="shift-hours">${shift.hours}—á</div>` : ''}
                `;
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showLoading(show) {
            loading.classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
